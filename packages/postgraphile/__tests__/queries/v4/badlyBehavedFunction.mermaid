graph TD
    classDef path fill:#eee,stroke:#000,color:#000
    classDef plan fill:#fff,stroke-width:3px,color:#000
    classDef itemplan fill:#fff,stroke-width:6px,color:#000
    classDef sideeffectplan fill:#f00,stroke-width:6px,color:#000
    classDef bucket fill:#f6f6f6,color:#000,stroke-width:6px,text-align:left


    %% define steps
    __Value3["__Value[3∈0]<br />ᐸcontextᐳ"]:::plan
    __Value5["__Value[5∈0]<br />ᐸrootValueᐳ"]:::plan
    Access30["Access[30∈0]<br />ᐸ3.pgSettingsᐳ"]:::plan
    Access31["Access[31∈0]<br />ᐸ3.withPgClientᐳ"]:::plan
    Object32["Object[32∈0]<br />ᐸ{pgSettings,withPgClient}ᐳ"]:::plan
    Connection33["Connection[33∈0]<br />ᐸ29ᐳ"]:::plan
    PgSelect34[["PgSelect[34∈0]<br />ᐸbadly_behaved_functionᐳ"]]:::plan
    __ListTransform35[["__ListTransform[35∈0]<br />ᐸeach:34ᐳ"]]:::plan
    __ListTransform39[["__ListTransform[39∈0]<br />ᐸeach:38ᐳ"]]:::plan
    __Item42>"__Item[42∈3]<br />ᐸ35ᐳ"]:::itemplan
    PgSelectSingle43["PgSelectSingle[43∈3]<br />ᐸbadly_behaved_functionᐳ"]:::plan
    Constant44["Constant[44∈3]"]:::plan
    PgClassExpression45["PgClassExpression[45∈3]<br />ᐸ__badly_be...ion__.”id”ᐳ"]:::plan
    List46["List[46∈3]<br />ᐸ44,45ᐳ"]:::plan
    Lambda47["Lambda[47∈3]<br />ᐸencodeᐳ"]:::plan
    PgClassExpression50["PgClassExpression[50∈3]<br />ᐸ”c”.”perso...unction__)ᐳ"]:::plan
    __Item51>"__Item[51∈4]<br />ᐸ39ᐳ"]:::itemplan
    PgSelectSingle52["PgSelectSingle[52∈4]<br />ᐸbadly_behaved_functionᐳ"]:::plan
    PgClassExpression55["PgClassExpression[55∈4]<br />ᐸrow_number...tion by 1)ᐳ"]:::plan
    List56["List[56∈4]<br />ᐸ55ᐳ"]:::plan
    PgCursor54["PgCursor[54∈4]"]:::plan
    Edge53["Edge[53∈4]"]:::plan
    Constant57["Constant[57∈4]"]:::plan
    PgClassExpression58["PgClassExpression[58∈4]<br />ᐸ__badly_be...ion__.”id”ᐳ"]:::plan
    List59["List[59∈4]<br />ᐸ57,58ᐳ"]:::plan
    Lambda60["Lambda[60∈4]<br />ᐸencodeᐳ"]:::plan
    PgClassExpression63["PgClassExpression[63∈4]<br />ᐸ”c”.”perso...unction__)ᐳ"]:::plan

    %% plan dependencies
    __Value3 --> Access30
    __Value3 --> Access31
    Access30 & Access31 --> Object32
    Object32 & Connection33 --> PgSelect34
    PgSelect34 --> __ListTransform35
    PgSelect34 --> __ListTransform39
    __ListTransform35 ==> __Item42
    __Item42 --> PgSelectSingle43
    PgSelectSingle43 --> PgClassExpression45
    Constant44 & PgClassExpression45 --> List46
    List46 --> Lambda47
    PgSelectSingle43 --> PgClassExpression50
    __ListTransform39 ==> __Item51
    __Item51 --> PgSelectSingle52
    PgSelectSingle52 --> PgClassExpression55
    PgClassExpression55 --> List56
    List56 --> PgCursor54
    PgSelectSingle52 & PgCursor54 --> Edge53
    PgSelectSingle52 --> PgClassExpression58
    Constant57 & PgClassExpression58 --> List59
    List59 --> Lambda60
    PgSelectSingle52 --> PgClassExpression63

    %% plan-to-path relationships

    subgraph "Buckets for queries/v4/badlyBehavedFunction"
    Bucket0("Bucket 0<br />(root)"):::bucket
    classDef bucket0 stroke:#696969
    class Bucket0,__Value3,__Value5,Access30,Access31,Object32,Connection33,PgSelect34,__ListTransform35,__ListTransform39 bucket0
    Bucket1("Bucket 1<br />(subroutine)<br />ROOT null"):::bucket
    classDef bucket1 stroke:#00bfff
    class Bucket1 bucket1
    Bucket2("Bucket 2<br />(subroutine)<br />ROOT null"):::bucket
    classDef bucket2 stroke:#7f007f
    class Bucket2 bucket2
    Bucket3("Bucket 3<br />(listItem)<br />Deps: 35<br /><br />ROOT __Item{3}ᐸ35ᐳ[42]"):::bucket
    classDef bucket3 stroke:#ffa500
    class Bucket3,__Item42,PgSelectSingle43,Constant44,PgClassExpression45,List46,Lambda47,PgClassExpression50 bucket3
    Bucket4("Bucket 4<br />(listItem)<br />Deps: 39<br /><br />ROOT __Item{4}ᐸ39ᐳ[51]"):::bucket
    classDef bucket4 stroke:#0000ff
    class Bucket4,__Item51,PgSelectSingle52,Edge53,PgCursor54,PgClassExpression55,List56,Constant57,PgClassExpression58,List59,Lambda60,PgClassExpression63 bucket4
    Bucket0 --> Bucket1 & Bucket2 & Bucket3 & Bucket4
    end
