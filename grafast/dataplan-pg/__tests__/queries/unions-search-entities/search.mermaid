%%{init: {'themeVariables': { 'fontSize': '12px'}}}%%
graph TD
    classDef path fill:#eee,stroke:#000,color:#000
    classDef plan fill:#fff,stroke-width:1px,color:#000
    classDef itemplan fill:#fff,stroke-width:2px,color:#000
    classDef unbatchedplan fill:#dff,stroke-width:1px,color:#000
    classDef sideeffectplan fill:#fcc,stroke-width:2px,color:#000
    classDef bucket fill:#f6f6f6,color:#000,stroke-width:2px,text-align:left

    subgraph "Buckets for queries/unions-search-entities/search"
    Bucket0("Bucket 0 (root)<br /><br />1: <br />ᐳ: 8, 9, 107, 10, 11<br />2: PgSelect[7]<br />3: PgSelectRows[13]<br />4: __ListTransform[12]"):::bucket
    Bucket1("Bucket 1 (subroutine)<br /><br />ROOT PgSelectSingle{1}ᐸentity_searchᐳ[15]"):::bucket
    Bucket2("Bucket 2 (listItem)<br />Deps: 10<br /><br />ROOT __Item{2}ᐸ12ᐳ[16]<br />1: <br />ᐳ: 17, 18, 19, 20, 21<br />2: Lambda[22]<br />ᐳ: Access[23]"):::bucket
    Bucket3("Bucket 3 (polymorphic)<br />Person,Post,Comment<br />Deps: 22, 10, 23<br />ᐳPerson<br />ᐳPost<br />ᐳComment<br /><br />1: 95, 99, 103<br />ᐳ: Access[24], Access[38], Access[48]<br />2: 26, 40, 50<br />ᐳ: Access[96], Access[100], Access[104]<br />3: 35, 45, 55<br />ᐳ: 34, 37, 44, 47, 54, 57, 58, 59, 60, 70, 71, 90, 97, 98, 101, 102, 105, 106<br />4: 67, 78, 87<br />ᐳ: 66, 69, 77, 80, 86, 89"):::bucket
    Bucket4("Bucket 4 (nullableBoundary)<br />Deps: 69<br /><br />ROOT PgSelectSingle{3}ᐸpeopleᐳ[69]"):::bucket
    Bucket5("Bucket 5 (nullableBoundary)<br />Deps: 80<br /><br />ROOT PgSelectSingle{3}ᐸpeopleᐳ[80]"):::bucket
    Bucket6("Bucket 6 (nullableBoundary)<br />Deps: 89<br /><br />ROOT PgSelectSingle{3}ᐸpostsᐳ[89]"):::bucket
    end
    Bucket0 --> Bucket1 & Bucket2
    Bucket2 --> Bucket3
    Bucket3 --> Bucket4 & Bucket5 & Bucket6

    %% plan dependencies
    PgSelect7[["PgSelect[7∈0] ➊<br />ᐸentity_searchᐳ"]]:::plan
    Object10{{"Object[10∈0] ➊<br />ᐸ{pgSettings,withPgClient}ᐳ"}}:::plan
    PgFromExpression11{{"PgFromExpression[11∈0] ➊"}}:::plan
    Object10 & PgFromExpression11 --> PgSelect7
    Access8{{"Access[8∈0] ➊<br />ᐸ2.pgSettingsᐳ"}}:::plan
    Access9{{"Access[9∈0] ➊<br />ᐸ2.withPgClientᐳ"}}:::plan
    Access8 & Access9 --> Object10
    __ListTransform12[["__ListTransform[12∈0] ➊<br />ᐸeach:7ᐳ"]]:::plan
    PgSelectRows13[["PgSelectRows[13∈0] ➊"]]:::plan
    PgSelectRows13 & PgSelect7 --> __ListTransform12
    __Value2["__Value[2∈0] ➊<br />ᐸcontextᐳ"]:::plan
    __Value2 --> Access8
    __Value2 --> Access9
    Constant107{{"Constant[107∈0] ➊<br />ᐸ'Dave'ᐳ"}}:::plan
    Constant107 --> PgFromExpression11
    PgSelect7 --> PgSelectRows13
    __Value4["__Value[4∈0] ➊<br />ᐸrootValueᐳ"]:::plan
    __Item14[/"__Item[14∈1]<br />ᐸ13ᐳ"\]:::itemplan
    PgSelectRows13 -.-> __Item14
    PgSelectSingle15{{"PgSelectSingle[15∈1]<br />ᐸentity_searchᐳ"}}:::plan
    __Item14 --> PgSelectSingle15
    List21{{"List[21∈2]<br />ᐸ18,19,20ᐳ"}}:::plan
    PgClassExpression18{{"PgClassExpression[18∈2]<br />ᐸ__entity_s...person_id”ᐳ"}}:::plan
    PgClassExpression19{{"PgClassExpression[19∈2]<br />ᐸ__entity_s....”post_id”ᐳ"}}:::plan
    PgClassExpression20{{"PgClassExpression[20∈2]<br />ᐸ__entity_s...omment_id”ᐳ"}}:::plan
    PgClassExpression18 & PgClassExpression19 & PgClassExpression20 --> List21
    __Item16[/"__Item[16∈2]<br />ᐸ12ᐳ"\]:::itemplan
    __ListTransform12 ==> __Item16
    PgSelectSingle17{{"PgSelectSingle[17∈2]<br />ᐸentity_searchᐳ"}}:::plan
    __Item16 --> PgSelectSingle17
    PgSelectSingle17 --> PgClassExpression18
    PgSelectSingle17 --> PgClassExpression19
    PgSelectSingle17 --> PgClassExpression20
    Lambda22[["Lambda[22∈2]"]]:::unbatchedplan
    List21 --> Lambda22
    Access23{{"Access[23∈2]<br />ᐸ22.__typenameᐳ"}}:::plan
    Lambda22 --> Access23
    PgSelect50[["PgSelect[50∈3]^<br />ᐸcommentsᐳ"]]:::plan
    Access48{{"Access[48∈3]<br />ᐸ22.comment_idᐳ<br />ᐳComment"}}:::plan
    PgSelectInlineApply99["PgSelectInlineApply[99∈3] ➊<br />ᐳComment"]:::plan
    PgSelectInlineApply103["PgSelectInlineApply[103∈3] ➊<br />ᐳComment"]:::plan
    Object10 & Access48 & PgSelectInlineApply99 & PgSelectInlineApply103 --> PgSelect50
    PgSelect40[["PgSelect[40∈3]^<br />ᐸpostsᐳ"]]:::plan
    Access38{{"Access[38∈3]<br />ᐸ22.post_idᐳ<br />ᐳPost"}}:::plan
    PgSelectInlineApply95["PgSelectInlineApply[95∈3] ➊<br />ᐳPost"]:::plan
    Object10 & Access38 & PgSelectInlineApply95 --> PgSelect40
    PgSelect26[["PgSelect[26∈3]^<br />ᐸpeopleᐳ"]]:::plan
    Access24{{"Access[24∈3]<br />ᐸ22.person_idᐳ<br />ᐳPerson"}}:::plan
    Object10 & Access24 --> PgSelect26
    List97{{"List[97∈3]^<br />ᐸ96,47ᐳ"}}:::plan
    Access96{{"Access[96∈3]^<br />ᐸ40.m.joinDetailsFor62ᐳ"}}:::plan
    PgSelectSingle47{{"PgSelectSingle[47∈3]^<br />ᐸpostsᐳ"}}:::plan
    Access96 & PgSelectSingle47 --> List97
    List101{{"List[101∈3]^<br />ᐸ100,57ᐳ"}}:::plan
    Access100{{"Access[100∈3]^<br />ᐸ50.m.joinDetailsFor73ᐳ"}}:::plan
    PgSelectSingle57{{"PgSelectSingle[57∈3]^<br />ᐸcommentsᐳ"}}:::plan
    Access100 & PgSelectSingle57 --> List101
    List105{{"List[105∈3]^<br />ᐸ104,57ᐳ"}}:::plan
    Access104{{"Access[104∈3]^<br />ᐸ50.m.joinDetailsFor82ᐳ"}}:::plan
    Access104 & PgSelectSingle57 --> List105
    Lambda22 --> Access24
    First34{{"First[34∈3]^"}}:::plan
    PgSelectRows35[["PgSelectRows[35∈3]^"]]:::plan
    PgSelectRows35 --> First34
    PgSelect26 --> PgSelectRows35
    PgSelectSingle37{{"PgSelectSingle[37∈3]^<br />ᐸpeopleᐳ"}}:::plan
    First34 --> PgSelectSingle37
    Lambda22 --> Access38
    First44{{"First[44∈3]^"}}:::plan
    PgSelectRows45[["PgSelectRows[45∈3]^"]]:::plan
    PgSelectRows45 --> First44
    PgSelect40 --> PgSelectRows45
    First44 --> PgSelectSingle47
    Lambda22 --> Access48
    First54{{"First[54∈3]^"}}:::plan
    PgSelectRows55[["PgSelectRows[55∈3]^"]]:::plan
    PgSelectRows55 --> First54
    PgSelect50 --> PgSelectRows55
    First54 --> PgSelectSingle57
    PgClassExpression58{{"PgClassExpression[58∈3]^<br />ᐸ__people__.”person_id”ᐳ"}}:::plan
    PgSelectSingle37 --> PgClassExpression58
    PgClassExpression59{{"PgClassExpression[59∈3]^<br />ᐸ__people__.”username”ᐳ"}}:::plan
    PgSelectSingle37 --> PgClassExpression59
    PgClassExpression60{{"PgClassExpression[60∈3]^<br />ᐸ__posts__.”post_id”ᐳ"}}:::plan
    PgSelectSingle47 --> PgClassExpression60
    First66{{"First[66∈3]^"}}:::plan
    PgSelectRows67[["PgSelectRows[67∈3]^"]]:::plan
    PgSelectRows67 --> First66
    Lambda98{{"Lambda[98∈3]^<br />ᐸpgInlineViaJoinTransformᐳ"}}:::plan
    Lambda98 --> PgSelectRows67
    PgSelectSingle69{{"PgSelectSingle[69∈3]^<br />ᐸpeopleᐳ"}}:::plan
    First66 --> PgSelectSingle69
    PgClassExpression70{{"PgClassExpression[70∈3]^<br />ᐸ__posts__.”body”ᐳ"}}:::plan
    PgSelectSingle47 --> PgClassExpression70
    PgClassExpression71{{"PgClassExpression[71∈3]^<br />ᐸ__comments...omment_id”ᐳ"}}:::plan
    PgSelectSingle57 --> PgClassExpression71
    First77{{"First[77∈3]^"}}:::plan
    PgSelectRows78[["PgSelectRows[78∈3]^"]]:::plan
    PgSelectRows78 --> First77
    Lambda102{{"Lambda[102∈3]^<br />ᐸpgInlineViaJoinTransformᐳ"}}:::plan
    Lambda102 --> PgSelectRows78
    PgSelectSingle80{{"PgSelectSingle[80∈3]^<br />ᐸpeopleᐳ"}}:::plan
    First77 --> PgSelectSingle80
    First86{{"First[86∈3]^"}}:::plan
    PgSelectRows87[["PgSelectRows[87∈3]^"]]:::plan
    PgSelectRows87 --> First86
    Lambda106{{"Lambda[106∈3]^<br />ᐸpgInlineViaJoinTransformᐳ"}}:::plan
    Lambda106 --> PgSelectRows87
    PgSelectSingle89{{"PgSelectSingle[89∈3]^<br />ᐸpostsᐳ"}}:::plan
    First86 --> PgSelectSingle89
    PgClassExpression90{{"PgClassExpression[90∈3]^<br />ᐸ__comments__.”body”ᐳ"}}:::plan
    PgSelectSingle57 --> PgClassExpression90
    PgSelect40 --> Access96
    List97 --> Lambda98
    PgSelect50 --> Access100
    List101 --> Lambda102
    PgSelect50 --> Access104
    List105 --> Lambda106
    PgClassExpression91{{"PgClassExpression[91∈4]<br />ᐸ__people__.”username”ᐳ<br />ᐳPost"}}:::plan
    PgSelectSingle69 --> PgClassExpression91
    PgClassExpression92{{"PgClassExpression[92∈5]<br />ᐸ__people__.”username”ᐳ<br />ᐳComment"}}:::plan
    PgSelectSingle80 --> PgClassExpression92
    PgClassExpression93{{"PgClassExpression[93∈6]<br />ᐸ__posts__.”post_id”ᐳ<br />ᐳComment"}}:::plan
    PgSelectSingle89 --> PgClassExpression93
    PgClassExpression94{{"PgClassExpression[94∈6]<br />ᐸ__posts__.”body”ᐳ<br />ᐳComment"}}:::plan
    PgSelectSingle89 --> PgClassExpression94

    %% define steps
    classDef bucket0 stroke:#696969
    class Bucket0,__Value2,__Value4,PgSelect7,Access8,Access9,Object10,PgFromExpression11,__ListTransform12,PgSelectRows13,Constant107 bucket0
    classDef bucket1 stroke:#00bfff
    class Bucket1,__Item14,PgSelectSingle15 bucket1
    classDef bucket2 stroke:#7f007f
    class Bucket2,__Item16,PgSelectSingle17,PgClassExpression18,PgClassExpression19,PgClassExpression20,List21,Lambda22,Access23 bucket2
    classDef bucket3 stroke:#ffa500
    class Bucket3,Access24,PgSelect26,First34,PgSelectRows35,PgSelectSingle37,Access38,PgSelect40,First44,PgSelectRows45,PgSelectSingle47,Access48,PgSelect50,First54,PgSelectRows55,PgSelectSingle57,PgClassExpression58,PgClassExpression59,PgClassExpression60,First66,PgSelectRows67,PgSelectSingle69,PgClassExpression70,PgClassExpression71,First77,PgSelectRows78,PgSelectSingle80,First86,PgSelectRows87,PgSelectSingle89,PgClassExpression90,PgSelectInlineApply95,Access96,List97,Lambda98,PgSelectInlineApply99,Access100,List101,Lambda102,PgSelectInlineApply103,Access104,List105,Lambda106 bucket3
    classDef bucket4 stroke:#0000ff
    class Bucket4,PgClassExpression91 bucket4
    classDef bucket5 stroke:#7fff00
    class Bucket5,PgClassExpression92 bucket5
    classDef bucket6 stroke:#ff1493
    class Bucket6,PgClassExpression93,PgClassExpression94 bucket6

