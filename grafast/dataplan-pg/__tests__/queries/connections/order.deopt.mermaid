%%{init: {'themeVariables': { 'fontSize': '12px'}}}%%
graph TD
    classDef path fill:#eee,stroke:#000,color:#000
    classDef plan fill:#fff,stroke-width:1px,color:#000
    classDef itemplan fill:#fff,stroke-width:2px,color:#000
    classDef unbatchedplan fill:#dff,stroke-width:1px,color:#000
    classDef sideeffectplan fill:#fcc,stroke-width:2px,color:#000
    classDef bucket fill:#f6f6f6,color:#000,stroke-width:2px,text-align:left

    subgraph "Buckets for queries/connections/order"
    Bucket0("Bucket 0 (root)"):::bucket
    Bucket1("Bucket 1 (nullableBoundary)<br />Deps: 14, 19, 16, 81, 6<br /><br />ROOT Connectionᐸ10ᐳ[16]<br />1: PgSelect[21], PgSelect[25]<br />ᐳ: 24, 36, 38, 39, 44, 45, 52<br />2: PgSelectRows[27], PgSelectRows[31]<br />ᐳ: 26, 29, 30, 48, 51, 54, 56, 58, 61"):::bucket
    Bucket2("Bucket 2 (listItem)<br />Deps: 52, 14<br /><br />ROOT __Item{2}ᐸ31ᐳ[32]"):::bucket
    Bucket3("Bucket 3 (nullableBoundary)<br />Deps: 33, 52, 14<br /><br />ROOT PgSelectSingle{2}ᐸmessagesᐳ[33]<br />1: <br />ᐳ: 64, 65, 66<br />2: PgSelect[67]<br />3: PgSelectRows[75]<br />ᐳ: First[74], PgSelectSingle[77]"):::bucket
    Bucket4("Bucket 4 (nullableBoundary)<br />Deps: 77<br /><br />ROOT PgSelectSingle{3}ᐸusersᐳ[77]"):::bucket
    end
    Bucket0 --> Bucket1
    Bucket1 --> Bucket2
    Bucket2 --> Bucket3
    Bucket3 --> Bucket4

    %% plan dependencies
    Object14{{"Object[14∈0] ➊<br />ᐸ{pgSettings,withPgClient}ᐳ"}}:::plan
    Access11{{"Access[11∈0] ➊<br />ᐸ2.pgSettingsᐳ"}}:::plan
    Access13{{"Access[13∈0] ➊<br />ᐸ2.withPgClientᐳ"}}:::plan
    Access11 & Access13 --> Object14
    __Value2["__Value[2∈0] ➊<br />ᐸcontextᐳ"]:::plan
    __Value2 --> Access11
    __Value2 --> Access13
    Connection16{{"Connection[16∈0] ➊<br />ᐸ10ᐳ"}}:::plan
    Constant81{{"Constant[81∈0] ➊<br />ᐸ5ᐳ"}}:::plan
    Constant81 --> Connection16
    Lambda19{{"Lambda[19∈0] ➊<br />ᐸincludeArchivedConditionᐳ"}}:::plan
    Constant80{{"Constant[80∈0] ➊<br />ᐸ[ undefined, 'INHERIT' ]ᐳ"}}:::plan
    Constant80 --> Lambda19
    __Value4["__Value[4∈0] ➊<br />ᐸrootValueᐳ"]:::plan
    PgSelect21[["PgSelect[21∈1] ➊<br />ᐸmessages+1ᐳ"]]:::plan
    Object14 & Lambda19 & Connection16 & Constant81 --> PgSelect21
    Object44{{"Object[44∈1] ➊<br />ᐸ{first,last,offset,hasMore}ᐳ"}}:::plan
    Access36{{"Access[36∈1] ➊<br />ᐸ21.hasMoreᐳ"}}:::plan
    Constant81 & Access36 --> Object44
    PgSelect25[["PgSelect[25∈1] ➊<br />ᐸmessages(aggregate)ᐳ"]]:::plan
    Object14 & Lambda19 & Connection16 --> PgSelect25
    Object38{{"Object[38∈1] ➊<br />ᐸ{first,last,hasMore}ᐳ"}}:::plan
    Constant81 & Access36 --> Object38
    PgCursor54{{"PgCursor[54∈1] ➊"}}:::plan
    PgSelectSingle51{{"PgSelectSingle[51∈1] ➊<br />ᐸmessagesᐳ"}}:::plan
    Access52{{"Access[52∈1] ➊<br />ᐸ21.cursorDetailsᐳ"}}:::plan
    PgSelectSingle51 & Access52 --> PgCursor54
    PgCursor61{{"PgCursor[61∈1] ➊"}}:::plan
    PgSelectSingle58{{"PgSelectSingle[58∈1] ➊<br />ᐸmessagesᐳ"}}:::plan
    PgSelectSingle58 & Access52 --> PgCursor61
    PgPageInfo24{{"PgPageInfo[24∈1] ➊"}}:::plan
    Connection16 --> PgPageInfo24
    First26{{"First[26∈1] ➊"}}:::plan
    PgSelectRows27[["PgSelectRows[27∈1] ➊"]]:::plan
    PgSelectRows27 --> First26
    PgSelect25 --> PgSelectRows27
    PgSelectSingle29{{"PgSelectSingle[29∈1] ➊<br />ᐸmessagesᐳ"}}:::plan
    First26 --> PgSelectSingle29
    PgClassExpression30{{"PgClassExpression[30∈1] ➊<br />ᐸcount(*)ᐳ"}}:::plan
    PgSelectSingle29 --> PgClassExpression30
    PgSelectRows31[["PgSelectRows[31∈1] ➊"]]:::plan
    PgSelect21 --> PgSelectRows31
    PgSelect21 --> Access36
    Lambda39{{"Lambda[39∈1] ➊<br />ᐸhasNextPageCbᐳ"}}:::plan
    Object38 --> Lambda39
    Lambda45{{"Lambda[45∈1] ➊<br />ᐸhasPreviousPageCbᐳ"}}:::plan
    Object44 --> Lambda45
    First48{{"First[48∈1] ➊"}}:::plan
    PgSelectRows31 --> First48
    First48 --> PgSelectSingle51
    PgSelect21 --> Access52
    Last56{{"Last[56∈1] ➊"}}:::plan
    PgSelectRows31 --> Last56
    Last56 --> PgSelectSingle58
    __Item32[/"__Item[32∈2]<br />ᐸ31ᐳ"\]:::itemplan
    PgSelectRows31 ==> __Item32
    PgSelectSingle33{{"PgSelectSingle[33∈2]<br />ᐸmessagesᐳ"}}:::plan
    __Item32 --> PgSelectSingle33
    PgCursor64{{"PgCursor[64∈3]"}}:::plan
    PgSelectSingle33 & Access52 --> PgCursor64
    PgSelect67[["PgSelect[67∈3]<br />ᐸusersᐳ"]]:::plan
    PgClassExpression66{{"PgClassExpression[66∈3]<br />ᐸ__messages...author_id”ᐳ"}}:::plan
    Object14 & PgClassExpression66 --> PgSelect67
    PgClassExpression65{{"PgClassExpression[65∈3]<br />ᐸ__messages__.”body”ᐳ"}}:::plan
    PgSelectSingle33 --> PgClassExpression65
    PgSelectSingle33 --> PgClassExpression66
    First74{{"First[74∈3]"}}:::plan
    PgSelectRows75[["PgSelectRows[75∈3]"]]:::plan
    PgSelectRows75 --> First74
    PgSelect67 --> PgSelectRows75
    PgSelectSingle77{{"PgSelectSingle[77∈3]<br />ᐸusersᐳ"}}:::plan
    First74 --> PgSelectSingle77
    PgClassExpression78{{"PgClassExpression[78∈4]<br />ᐸ__users__.”username”ᐳ"}}:::plan
    PgSelectSingle77 --> PgClassExpression78
    PgClassExpression79{{"PgClassExpression[79∈4]<br />ᐸ__users__....vatar_url”ᐳ"}}:::plan
    PgSelectSingle77 --> PgClassExpression79

    %% define steps
    classDef bucket0 stroke:#696969
    class Bucket0,__Value2,__Value4,Access11,Access13,Object14,Connection16,Lambda19,Constant80,Constant81 bucket0
    classDef bucket1 stroke:#00bfff
    class Bucket1,PgSelect21,PgPageInfo24,PgSelect25,First26,PgSelectRows27,PgSelectSingle29,PgClassExpression30,PgSelectRows31,Access36,Object38,Lambda39,Object44,Lambda45,First48,PgSelectSingle51,Access52,PgCursor54,Last56,PgSelectSingle58,PgCursor61 bucket1
    classDef bucket2 stroke:#7f007f
    class Bucket2,__Item32,PgSelectSingle33 bucket2
    classDef bucket3 stroke:#ffa500
    class Bucket3,PgCursor64,PgClassExpression65,PgClassExpression66,PgSelect67,First74,PgSelectRows75,PgSelectSingle77 bucket3
    classDef bucket4 stroke:#0000ff
    class Bucket4,PgClassExpression78,PgClassExpression79 bucket4

