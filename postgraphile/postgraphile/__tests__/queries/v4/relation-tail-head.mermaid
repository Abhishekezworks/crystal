%%{init: {'themeVariables': { 'fontSize': '12px'}}}%%
graph TD
    classDef path fill:#eee,stroke:#000,color:#000
    classDef plan fill:#fff,stroke-width:1px,color:#000
    classDef itemplan fill:#fff,stroke-width:2px,color:#000
    classDef sideeffectplan fill:#f00,stroke-width:2px,color:#000
    classDef bucket fill:#f6f6f6,color:#000,stroke-width:2px,text-align:left


    %% define steps
    __Value3["__Value[3∈0]<br />ᐸcontextᐳ"]:::plan
    __Value5["__Value[5∈0]<br />ᐸrootValueᐳ"]:::plan
    Access20["Access[20∈0]<br />ᐸ3.pgSettingsᐳ"]:::plan
    Access21["Access[21∈0]<br />ᐸ3.withPgClientᐳ"]:::plan
    Object22["Object[22∈0]<br />ᐸ{pgSettings,withPgClient}ᐳ"]:::plan
    Connection23["Connection[23∈0]<br />ᐸ19ᐳ"]:::plan
    PgSelect24[["PgSelect[24∈0]<br />ᐸcompoundKeyᐳ"]]:::plan
    __Item25>"__Item[25∈1]<br />ᐸ24ᐳ"]:::itemplan
    PgSelectSingle26["PgSelectSingle[26∈1]<br />ᐸcompoundKeyᐳ"]:::plan
    PgClassExpression27["PgClassExpression[27∈1]<br />ᐸ__compound...rson_id_1”ᐳ"]:::plan
    PgClassExpression28["PgClassExpression[28∈1]<br />ᐸ__compound...rson_id_2”ᐳ"]:::plan
    PgClassExpression29["PgClassExpression[29∈1]<br />ᐸ__compound...__.”extra”ᐳ"]:::plan
    Map93["Map[93∈1]<br />ᐸ26:{”0”:1,”1”:2}ᐳ"]:::plan
    PgSelectSingle36["PgSelectSingle[36∈1]<br />ᐸpersonᐳ"]:::plan
    PgClassExpression37["PgClassExpression[37∈1]<br />ᐸ__person__...full_name”ᐳ"]:::plan
    PgClassExpression38["PgClassExpression[38∈1]<br />ᐸ__person__.”email”ᐳ"]:::plan
    Map97["Map[97∈1]<br />ᐸ26:{”0”:4,”1”:5}ᐳ"]:::plan
    PgSelectSingle45["PgSelectSingle[45∈1]<br />ᐸpersonᐳ"]:::plan
    PgClassExpression46["PgClassExpression[46∈1]<br />ᐸ__person__...full_name”ᐳ"]:::plan
    PgClassExpression47["PgClassExpression[47∈1]<br />ᐸ__person__.”email”ᐳ"]:::plan
    Connection66["Connection[66∈0]<br />ᐸ62ᐳ"]:::plan
    PgSelect67[["PgSelect[67∈0]<br />ᐸforeignKeyᐳ"]]:::plan
    __Item68>"__Item[68∈2]<br />ᐸ67ᐳ"]:::itemplan
    PgSelectSingle69["PgSelectSingle[69∈2]<br />ᐸforeignKeyᐳ"]:::plan
    PgClassExpression70["PgClassExpression[70∈2]<br />ᐸ__foreign_...person_id”ᐳ"]:::plan
    PgClassExpression71["PgClassExpression[71∈2]<br />ᐸ__foreign_...und_key_1”ᐳ"]:::plan
    PgClassExpression72["PgClassExpression[72∈2]<br />ᐸ__foreign_...und_key_2”ᐳ"]:::plan
    Map99["Map[99∈2]<br />ᐸ69:{”0”:5,”1”:6}ᐳ"]:::plan
    PgSelectSingle79["PgSelectSingle[79∈2]<br />ᐸpersonᐳ"]:::plan
    PgClassExpression80["PgClassExpression[80∈2]<br />ᐸ__person__...full_name”ᐳ"]:::plan
    PgClassExpression81["PgClassExpression[81∈2]<br />ᐸ__person__.”email”ᐳ"]:::plan
    Map95["Map[95∈2]<br />ᐸ69:{”0”:0,”1”:1,”2”:2}ᐳ"]:::plan
    PgSelectSingle89["PgSelectSingle[89∈2]<br />ᐸcompoundKeyᐳ"]:::plan
    PgClassExpression90["PgClassExpression[90∈2]<br />ᐸ__compound...rson_id_1”ᐳ"]:::plan
    PgClassExpression91["PgClassExpression[91∈2]<br />ᐸ__compound...rson_id_2”ᐳ"]:::plan
    PgClassExpression92["PgClassExpression[92∈2]<br />ᐸ__compound...__.”extra”ᐳ"]:::plan

    %% plan dependencies
    __Value3 --> Access20
    __Value3 --> Access21
    Access20 & Access21 --> Object22
    Object22 & Connection23 --> PgSelect24
    PgSelect24 ==> __Item25
    __Item25 --> PgSelectSingle26
    PgSelectSingle26 --> PgClassExpression27
    PgSelectSingle26 --> PgClassExpression28
    PgSelectSingle26 --> PgClassExpression29
    PgSelectSingle26 --> Map93
    Map93 --> PgSelectSingle36
    PgSelectSingle36 --> PgClassExpression37
    PgSelectSingle36 --> PgClassExpression38
    PgSelectSingle26 --> Map97
    Map97 --> PgSelectSingle45
    PgSelectSingle45 --> PgClassExpression46
    PgSelectSingle45 --> PgClassExpression47
    Object22 & Connection66 --> PgSelect67
    PgSelect67 ==> __Item68
    __Item68 --> PgSelectSingle69
    PgSelectSingle69 --> PgClassExpression70
    PgSelectSingle69 --> PgClassExpression71
    PgSelectSingle69 --> PgClassExpression72
    PgSelectSingle69 --> Map99
    Map99 --> PgSelectSingle79
    PgSelectSingle79 --> PgClassExpression80
    PgSelectSingle79 --> PgClassExpression81
    PgSelectSingle69 --> Map95
    Map95 --> PgSelectSingle89
    PgSelectSingle89 --> PgClassExpression90
    PgSelectSingle89 --> PgClassExpression91
    PgSelectSingle89 --> PgClassExpression92

    subgraph "Buckets for queries/v4/relation-tail-head"
    Bucket0("Bucket 0 (root)"):::bucket
    classDef bucket0 stroke:#696969
    class Bucket0,__Value3,__Value5,Access20,Access21,Object22,Connection23,PgSelect24,Connection66,PgSelect67 bucket0
    Bucket1("Bucket 1 (listItem)<br />ROOT __Item{1}ᐸ24ᐳ[25]"):::bucket
    classDef bucket1 stroke:#00bfff
    class Bucket1,__Item25,PgSelectSingle26,PgClassExpression27,PgClassExpression28,PgClassExpression29,PgSelectSingle36,PgClassExpression37,PgClassExpression38,PgSelectSingle45,PgClassExpression46,PgClassExpression47,Map93,Map97 bucket1
    Bucket2("Bucket 2 (listItem)<br />ROOT __Item{2}ᐸ67ᐳ[68]"):::bucket
    classDef bucket2 stroke:#7f007f
    class Bucket2,__Item68,PgSelectSingle69,PgClassExpression70,PgClassExpression71,PgClassExpression72,PgSelectSingle79,PgClassExpression80,PgClassExpression81,PgSelectSingle89,PgClassExpression90,PgClassExpression91,PgClassExpression92,Map95,Map99 bucket2
    Bucket0 --> Bucket1 & Bucket2
    end
