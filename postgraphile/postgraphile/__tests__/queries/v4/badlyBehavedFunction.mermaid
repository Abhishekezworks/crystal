%%{init: {'themeVariables': { 'fontSize': '12px'}}}%%
graph TD
    classDef path fill:#eee,stroke:#000,color:#000
    classDef plan fill:#fff,stroke-width:1px,color:#000
    classDef itemplan fill:#fff,stroke-width:2px,color:#000
    classDef sideeffectplan fill:#f00,stroke-width:2px,color:#000
    classDef bucket fill:#f6f6f6,color:#000,stroke-width:2px,text-align:left


    %% define steps
    __Value3["__Value[3∈0]<br />ᐸcontextᐳ"]:::plan
    __Value5["__Value[5∈0]<br />ᐸrootValueᐳ"]:::plan
    Access13["Access[13∈0]<br />ᐸ3.pgSettingsᐳ"]:::plan
    Access14["Access[14∈0]<br />ᐸ3.withPgClientᐳ"]:::plan
    Object15["Object[15∈0]<br />ᐸ{pgSettings,withPgClient}ᐳ"]:::plan
    Connection16["Connection[16∈0]<br />ᐸ12ᐳ"]:::plan
    PgSelect17[["PgSelect[17∈0]<br />ᐸbadly_behaved_functionᐳ"]]:::plan
    __ListTransform18[["__ListTransform[18∈0]<br />ᐸeach:17ᐳ"]]:::plan
    __Item19>"__Item[19∈1]<br />ᐸ17ᐳ"]:::itemplan
    PgSelectSingle20["PgSelectSingle[20∈1]<br />ᐸbadly_behaved_functionᐳ"]:::plan
    __Item21>"__Item[21∈2]<br />ᐸ18ᐳ"]:::itemplan
    PgSelectSingle22["PgSelectSingle[22∈2]<br />ᐸbadly_behaved_functionᐳ"]:::plan
    Constant23["Constant[23∈0]"]:::plan
    PgClassExpression24["PgClassExpression[24∈2]<br />ᐸ__badly_be...ion__.”id”ᐳ"]:::plan
    List25["List[25∈2]<br />ᐸ23,24ᐳ"]:::plan
    Lambda26["Lambda[26∈2]<br />ᐸbase64JSONEncodeᐳ"]:::plan
    PgClassExpression29["PgClassExpression[29∈2]<br />ᐸ”c”.”perso...unction__)ᐳ"]:::plan
    __ListTransform31[["__ListTransform[31∈0]<br />ᐸeach:30ᐳ"]]:::plan
    __Item32>"__Item[32∈3]<br />ᐸ17ᐳ"]:::itemplan
    PgSelectSingle33["PgSelectSingle[33∈3]<br />ᐸbadly_behaved_functionᐳ"]:::plan
    __Item34>"__Item[34∈4]<br />ᐸ31ᐳ"]:::itemplan
    PgSelectSingle35["PgSelectSingle[35∈4]<br />ᐸbadly_behaved_functionᐳ"]:::plan
    PgClassExpression38["PgClassExpression[38∈4]<br />ᐸrow_number...tion by 1)ᐳ"]:::plan
    List39["List[39∈4]<br />ᐸ38ᐳ"]:::plan
    PgCursor37["PgCursor[37∈4]"]:::plan
    Edge36["Edge[36∈4]"]:::plan
    Constant40["Constant[40∈0]"]:::plan
    PgClassExpression41["PgClassExpression[41∈4]<br />ᐸ__badly_be...ion__.”id”ᐳ"]:::plan
    List42["List[42∈4]<br />ᐸ40,41ᐳ"]:::plan
    Lambda43["Lambda[43∈4]<br />ᐸbase64JSONEncodeᐳ"]:::plan
    PgClassExpression46["PgClassExpression[46∈4]<br />ᐸ”c”.”perso...unction__)ᐳ"]:::plan

    %% plan dependencies
    __Value3 --> Access13
    __Value3 --> Access14
    Access13 & Access14 --> Object15
    Object15 & Connection16 --> PgSelect17
    PgSelect17 --> __ListTransform18
    PgSelect17 -.-> __Item19
    __Item19 --> PgSelectSingle20
    __ListTransform18 ==> __Item21
    __Item21 --> PgSelectSingle22
    PgSelectSingle22 --> PgClassExpression24
    Constant23 & PgClassExpression24 --> List25
    List25 --> Lambda26
    PgSelectSingle22 --> PgClassExpression29
    PgSelect17 --> __ListTransform31
    PgSelect17 -.-> __Item32
    __Item32 --> PgSelectSingle33
    __ListTransform31 ==> __Item34
    __Item34 --> PgSelectSingle35
    PgSelectSingle35 --> PgClassExpression38
    PgClassExpression38 --> List39
    List39 --> PgCursor37
    PgSelectSingle35 & PgCursor37 --> Edge36
    PgSelectSingle35 --> PgClassExpression41
    Constant40 & PgClassExpression41 --> List42
    List42 --> Lambda43
    PgSelectSingle35 --> PgClassExpression46

    subgraph "Buckets for queries/v4/badlyBehavedFunction"
    Bucket0("Bucket 0 (root)"):::bucket
    classDef bucket0 stroke:#696969
    class Bucket0,__Value3,__Value5,Access13,Access14,Object15,Connection16,PgSelect17,__ListTransform18,Constant23,__ListTransform31,Constant40 bucket0
    Bucket1("Bucket 1 (subroutine)<br />ROOT PgSelectSingle{1}ᐸbadly_behaved_functionᐳ[20]"):::bucket
    classDef bucket1 stroke:#00bfff
    class Bucket1,__Item19,PgSelectSingle20 bucket1
    Bucket2("Bucket 2 (listItem)<br />Deps: 23<br /><br />ROOT __Item{2}ᐸ18ᐳ[21]"):::bucket
    classDef bucket2 stroke:#7f007f
    class Bucket2,__Item21,PgSelectSingle22,PgClassExpression24,List25,Lambda26,PgClassExpression29 bucket2
    Bucket3("Bucket 3 (subroutine)<br />ROOT PgSelectSingle{3}ᐸbadly_behaved_functionᐳ[33]"):::bucket
    classDef bucket3 stroke:#ffa500
    class Bucket3,__Item32,PgSelectSingle33 bucket3
    Bucket4("Bucket 4 (listItem)<br />Deps: 40<br /><br />ROOT __Item{4}ᐸ31ᐳ[34]"):::bucket
    classDef bucket4 stroke:#0000ff
    class Bucket4,__Item34,PgSelectSingle35,Edge36,PgCursor37,PgClassExpression38,List39,PgClassExpression41,List42,Lambda43,PgClassExpression46 bucket4
    Bucket0 --> Bucket1 & Bucket2 & Bucket3 & Bucket4
    end
